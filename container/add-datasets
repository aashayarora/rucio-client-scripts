#!/usr/bin/env python3
from rucio.client import Client

import random
import string
from tqdm import tqdm

client = Client()

datasets = {
    "T2_US_SDSC": "65000,74000", 
    "T2_US_Caltech": "170000,180000", 
    "T2_US_Caltech_Test": "105000,115000", 
    "T1_US_FNAL": "50000,59000", 
    "T2_US_Nebraska": "130000,140000"
}

containers = {
    "T2_US_SDSC": "SDSC",
    "T2_US_Caltech": "Caltech",
    "T2_US_Caltech_Test": "CALTECHTEST",
    "T1_US_FNAL": "FNAL",
    "T2_US_Nebraska": "NEBRASKA"
}

for source in datasets:
    DATASET = datasets[source]

    dataset_start, dataset_end = int(DATASET.split(",")[0]), int(DATASET.split(",")[1])+1000

    print("Adding files to datasets")
    datasets_for_containers = []
    for dataset in tqdm(range(dataset_start, dataset_end, 1000)):
        files = [f"/store/data/Run2018A/EGamma/MINIAOD/UL2018_MiniAODv2-v1/{dataset}/testSourceFile{j}.root" for j in range(1000)]
        dids = [{"scope": "cms", "name": f} for f in files]
        dids_w_bytes = [{"scope": "cms", "name": f, "bytes": 4294967296} for f in files]
        try:
            client.add_replicas(source, dids_w_bytes)
            client.add_dataset("cms", f"/SenseTest/Run2022-03Jan2023/MYDATA#{dataset}")
            client.add_files_to_datasets([{"scope": "cms", "name": f"/SenseTest/Run2022-03Jan2023/MYDATA#{dataset}", "dids": dids}])
        except:
            continue # ignore if file already exists

        datasets_for_containers.append({"scope": "cms", "name": f"/SenseTest/Run2022-03Jan2023/MYDATA#{dataset}"})

    random.shuffle(datasets_for_containers)

    print("Adding datasets to container")
    client.add_container("cms", f"/SenseTest/Run3/{containers[source]}")
    client.add_datasets_to_containers([{"scope": "cms", "name": f"/SenseTest/Run3/{containers[source]}", "dids": datasets_for_containers}])
